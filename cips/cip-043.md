| cip | 43 |
| - | - |
| title | Fee address module |
| description | Forward TIA tokens to protocol revenue via a dedicated fee address |
| author | Manav Aggarwal ([@Manav-Aggarwal](https://github.com/Manav-Aggarwal)) |
| discussions-to | <https://forum.celestia.org/t/cip-add-burn-module/2216> |
| status | Draft |
| type | Standards Track |
| category | Core |
| created | 2025-01-14 |

## Abstract

This proposal introduces a fee address module (`x/feeaddress`) that allows users to send TIA tokens to a dedicated address, which are then automatically forwarded to protocol revenue as transaction fees via protocol-injected transactions.

## Motivation

The fee address provides networks a simple way to contribute fees to Celestia. By converting fee address funds into real transaction fees, contributions appear in dashboard revenue calculations (e.g., Blockworks, Celenium).

## Specification

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 and RFC 8174.

### New Module: `x/feeaddress`

The fee address module is intentionally stateless and relies entirely on existing Cosmos SDK modules for token operations.

### Fee Address

Tokens MUST be sent to the following vanity address:

```
celestia1feefeefeefeefeefeefeefeefeefeefe8pxlcf
```

This address is derived from a recognizable byte pattern that encodes to "feefee..." in bech32, making it easily identifiable as a fee destination.

### Message Types

#### MsgForwardFees

This message is protocol-injected and MUST NOT be submitted by users directly.

```protobuf
message MsgForwardFees {}
```

The message has no signer and no fields. Validation happens entirely via ProcessProposal checking that `tx fee == fee address balance`.

### Validation Rules

The following ante decorators and IBC middleware enforce token restrictions:

- Only `utia` (the native staking token) MAY be sent to the fee address
- Attempts to send other denoms (IBC tokens, etc.) MUST be rejected
- IBC transfers to the fee address MUST be rejected to prevent foreign tokens from getting stuck

### Protocol-Injected Fee Forward Transaction

#### PrepareProposal

When preparing a block proposal, the block proposer:

1. Queries the fee address `utia` balance
2. If balance is non-zero:
   - Creates a `MsgForwardFees` transaction
   - Sets the transaction fee to the **entire fee address balance**
   - Sets gas limit to 50,000 (minimal, no computation)
   - Does NOT sign the transaction (unsigned)
   - Prepends the transaction to the block

Note: The fee forward tx is minimal (~100 bytes). If a block cannot accommodate it (practically impossible), tokens remain in the fee address until the next block.

#### ProcessProposal (Strict Validation)

All validators MUST enforce strict validation:

1. If fee address has a non-zero balance:
   - Block MUST contain a valid `MsgForwardFees` tx as the **first transaction**
   - Tx fee MUST equal the fee address balance
   - Block is REJECTED if any of these conditions fail
2. If fee address has zero balance:
   - Block MUST NOT contain a `MsgForwardFees` tx
   - Block is REJECTED if a fee forward tx is present

#### Ante Handler: FeeForwardDecorator

The `FeeForwardDecorator` processes `MsgForwardFees` transactions:

1. Deducts the transaction fee from the fee address (not from a signer)
2. Sends the fee to the fee collector module
3. Sets context flags to skip signature verification (the tx is unsigned)

Decorators that are skipped for fee forward transactions:
- `DeductFeeDecorator` (fee already deducted by FeeForwardDecorator)
- `ValidateTxFeeWrapper` (min gas price not applicable to protocol-injected tx)
- `SetPubKeyDecorator` (no signers)
- `ValidateSigCountDecorator` (no signatures)
- `SigGasConsumeDecorator` (no signatures)
- `SigVerificationDecorator` (no signatures)
- `IncrementSequenceDecorator` (no signers)

### Distribution

Forwarded fees are sent to the fee collector module, which contributes to protocol revenue. Currently, the distribution module allocates fee collector funds to validators at `BeginBlock`, which then pass it on to delegators as staking rewards. This distribution mechanism may be modified in future protocol upgrades.

### Event

```protobuf
message EventFeeForwarded {
  string from = 1;    // Address tokens were forwarded from
  string amount = 2;  // Amount forwarded (e.g., "1000000utia")
}
```

### Query

```protobuf
service Query {
  rpc FeeAddress(QueryFeeAddressRequest) returns (QueryFeeAddressResponse);
}

message QueryFeeAddressRequest {}

message QueryFeeAddressResponse {
  string fee_address = 1;
}
```

### CLI Usage

```shell
# Send tokens to the fee address (forwarded to protocol revenue in next block)
celestia-appd tx bank send mykey celestia1feefeefeefeefeefeefeefeefeefeefe8pxlcf 1000000utia

# Query the fee address
celestia-appd query feeaddress fee-address
```

## Parameters

This module introduces no new parameters.

## Rationale

### Dashboard Compatibility

Blockchain analytics dashboards (e.g., Blockworks, Celenium) calculate protocol revenue by aggregating transaction fees from the `tx.AuthInfo.Fee` field. A naive design using direct bank transfers in EndBlocker would not appear in these revenue calculations.

By injecting a real transaction with the fee address balance as its fee, the forwarded amount appears as actual transaction fee revenue.

### Distribution vs. Burn

The fee address forwards tokens to protocol revenue rather than burning them. This enables networks to contribute fees to Celestia.

### Strict Enforcement

ProcessProposal strictly enforces fee forwarding to ensure:
- No block proposer can "skip" forwarding to keep funds in the fee address
- Consensus on when/how funds are forwarded
- Predictable behavior for applications sending to the fee address

### Other Design Decisions

1. **No minimum balance threshold**: Forward any non-zero balance to minimize complexity. This means very small amounts (e.g., 1 utia) will trigger a fee forward tx with a low effective gas price. The fee forward tx skips min gas price validation since it's protocol-injected. The tradeoff is simplicity vs. batching small contributions - a minimum threshold would delay forwarding until accumulated, adding complexity.
2. **One fee forward per block**: All contributions in the fee address are batched into a single MsgForwardFees tx (~100 bytes overhead)
3. **Unsigned transaction**: Validated via ProcessProposal fee balance check, not signature
4. **Gas limit**: 50,000 (minimal - message handler only emits an event)

## Backwards Compatibility

This is a consensus-breaking change that requires a network upgrade. However, it is purely additive (new module) and does not affect existing functionality.

## Test Cases

Test cases are available in the reference implementation:

- Unit tests: `x/feeaddress/keeper_test.go`
- Integration tests: `x/feeaddress/test/feeaddress_test.go`

Tests cover successful forwarding, wrong denom rejection, IBC rejection, event emission, and ProcessProposal validation.

## Security Considerations

1. **Denom Restriction**: Only `utia` can be sent to the fee address. This is enforced by ante decorators and IBC middleware. This prevents IBC tokens or other bridged assets from getting stuck at the fee address with no way to recover them.

2. **IBC Protection**: IBC transfers to the fee address are rejected at the middleware level to prevent foreign tokens from being transferred via IBC.

3. **No Direct Access**: Users cannot withdraw from the fee address. Tokens are automatically forwarded as transaction fees.

4. **Strict Enforcement**: Blocks that fail to forward non-zero balances are rejected, preventing proposers from withholding funds.

## Reference Implementation

The implementation is available at: <https://github.com/celestiaorg/celestia-app/pull/6407>

## Copyright

Copyright and related rights waived via [CC0](https://github.com/celestiaorg/CIPs/blob/main/LICENSE).
